name: Build wezterm-git Arch Package

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          pacman -Sy --noconfirm --needed \
            base-devel git rust cargo pkgconf sudo \
            zlib libpng libjpeg-turbo libxcb xcb-util \
            hicolor-icon-theme libxkbcommon-x11 \
            xcb-util-image xcb-util-keysyms xcb-util-wm \
            cmake python fontconfig libx11 wayland libglvnd \
            libgit2 openssl libssh2 lua sqlite

      # QUICK TEST STEP: Fails fast (under 10s) if libraries are missing/wrong
      - name: Pre-build Validation
        run: |
          echo "Checking if linker can find required system libraries..."
          pkg-config --exists lua || (echo "ERROR: Lua not found" && exit 1)
          pkg-config --exists sqlite3 || (echo "ERROR: SQLite3 not found" && exit 1)
          pkg-config --exists libssh2 || (echo "ERROR: libssh2 not found" && exit 1)
          pkg-config --exists libgit2 || (echo "ERROR: libgit2 not found" && exit 1)
          echo "SUCCESS: All system dependencies verified via pkg-config."

      - name: Create unprivileged builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/builder
          pacman-key --init
          pacman-key --populate archlinux

      - name: Setup Workspace
        run: |
          mkdir -p /home/builder/build
          chown -R builder:builder /home/builder/build

      - name: Generate PKGBUILD dynamically
        run: |
          cat > /home/builder/build/PKGBUILD << 'EOF'
          pkgname=wezterm-git
          pkgver=0
          pkgrel=1
          pkgdesc="GPU-accelerated terminal emulator and multiplexer"
          arch=(x86_64)
          url="https://github.com/wez/wezterm"
          license=(MIT)
          depends=(fontconfig libx11 libxcb libxkbcommon wayland zlib libpng libjpeg-turbo libglvnd libgit2 openssl libssh2 lua sqlite)
          makedepends=(git rust cargo cmake python)
          source=("wezterm::git+https://github.com/wez/wezterm.git")
          sha256sums=("SKIP")

          pkgver() {
            cd "${srcdir}/wezterm"
            printf "%s.%s" "$(date +%Y%m%d)" "$(git rev-parse --short HEAD)"
          }

          build() {
            cd "${srcdir}/wezterm"
            
            # Use pkg-config for all system libraries to solve linker errors
            export LIBGIT2_SYS_USE_PKG_CONFIG=1
            export LIBSSH2_SYS_USE_PKG_CONFIG=1
            export LIBSQLITE3_SYS_USE_PKG_CONFIG=1
            export OPENSSL_NO_VENDOR=1
            
            # Targeting Lua 5.4 specifically for Arch
            export LUA_LIB=lua
            export LUA_LIB_NAME=lua
            export LUA_VERSION=5.4
            export LUA_LOCAL_ANY=1
            
            cargo build --release
          }

          package() {
            cd "${srcdir}/wezterm"
            install -Dm755 target/release/wezterm "${pkgdir}/usr/bin/wezterm"
            install -Dm755 target/release/wezterm-mux-server "${pkgdir}/usr/bin/wezterm-mux-server"
            install -Dm755 target/release/wezterm-gui "${pkgdir}/usr/bin/wezterm-gui"
            
            install -Dm644 assets/icon/terminal.png "${pkgdir}/usr/share/icons/hicolor/128x128/apps/org.wezfurlong.wezterm.png"
            install -Dm644 assets/wezterm.desktop "${pkgdir}/usr/share/applications/org.wezfurlong.wezterm.desktop"
            install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
          }
          EOF
          chown builder:builder /home/builder/build/PKGBUILD

      - name: Build the package with makepkg
        run: |
          sudo -u builder bash -lc '
            cd ~/build
            export MAKEFLAGS="-j$(nproc)"
            makepkg --noconfirm --skippgpcheck -s
          '

      - name: Gather build metadata
        id: build_meta
        run: |
          cd /home/builder/build
          pkg_file=$(ls *.pkg.tar.zst | head -n 1)
          if [ -z "$pkg_file" ]; then exit 1; fi
          final_ver=$(echo $pkg_file | cut -d'-' -f2,3)
          echo "build_tag=$(date '+%Y.%m.%d')-${final_ver}" >> "$GITHUB_OUTPUT"
          echo "build_date=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> "$GITHUB_OUTPUT"
        
      - name: Create GitHub Release & Upload Package
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build_meta.outputs.build_tag }}
          name: wezterm-git ${{ steps.build_meta.outputs.build_tag }}
          files: /home/builder/build/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
