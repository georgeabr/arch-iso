name: Build wezterm-git Arch Package

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          pacman -Sy --noconfirm --needed \
            base-devel git rust cargo pkgconf sudo \
            zlib libpng libjpeg-turbo libxcb xcb-util \
            hicolor-icon-theme libxkbcommon-x11 \
            xcb-util-image xcb-util-keysyms xcb-util-wm \
            cmake python fontconfig libx11 wayland libglvnd

      - name: Create unprivileged builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/builder
          # Initialize pacman keys for the container environment
          pacman-key --init
          pacman-key --populate archlinux

      - name: Setup Workspace
        run: |
          mkdir -p /home/builder/build
          chown -R builder:builder /home/builder/build

      - name: Generate PKGBUILD dynamically
        run: |
          cat > /home/builder/build/PKGBUILD << 'EOF'
          pkgname=wezterm-git
          pkgver=0
          pkgrel=1
          pkgdesc="GPU-accelerated terminal emulator and multiplexer"
          arch=(x86_64)
          url="https://github.com/wez/wezterm"
          license=(MIT)
          depends=(fontconfig libx11 libxcb libxkbcommon wayland zlib libpng libjpeg-turbo libglvnd)
          makedepends=(git rust cargo cmake python)
          source=("wezterm::git+https://github.com/wez/wezterm.git")
          sha256sums=("SKIP")

          pkgver() {
            cd "${srcdir}/wezterm"
            printf "%s.%s" "$(date +%Y%m%d)" "$(git rev-parse --short HEAD)"
          }

          build() {
            cd "${srcdir}/wezterm"
            cargo build --release
          }

          package() {
            cd "${srcdir}/wezterm"
            install -Dm755 target/release/wezterm "${pkgdir}/usr/bin/wezterm"
            install -Dm755 target/release/wezterm-mux-server "${pkgdir}/usr/bin/wezterm-mux-server"
            install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
          }
          EOF
          chown builder:builder /home/builder/build/PKGBUILD

      - name: Build the package with makepkg
        run: |
          sudo -u builder bash -lc '
            cd ~/build
            export MAKEFLAGS="-j$(nproc)"
            makepkg --noconfirm --needed --skippgpcheck -s
          '

      - name: Gather build metadata
        id: build_meta
        run: |
          cd /home/builder/build
          # Find the actual version generated by makepkg
          final_ver=$(ls *.pkg.tar.zst | cut -d'-' -f2,3)
          echo "build_tag=$(date '+%Y.%m.%d')-${final_ver}" >> "$GITHUB_OUTPUT"
          echo "build_date=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> "$GITHUB_OUTPUT"
          echo "architecture=$(uname -m)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release & Upload Package
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build_meta.outputs.build_tag }}
          name: wezterm-git ${{ steps.build_meta.outputs.build_tag }}
          body: |
            Package:      wezterm-git for Arch Linux
            Built on:     ${{ steps.build_meta.outputs.build_date }}
            Architecture: ${{ steps.build_meta.outputs.architecture }}
          files: /home/builder/build/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
