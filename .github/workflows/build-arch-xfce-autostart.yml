name: Build Auto Arch with XFCE

on:
  workflow_dispatch:
    inputs:
      build_date:
        description: 'ISO build timestamp (YYYYMMDD_HHMMSS). Leave empty for current time.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --privileged
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pacman -Sy --noconfirm archiso squashfs-tools xorriso dosfstools p7zip curl util-linux binutils jq

      - name: Prepare XFCE profile
        id: prepare_profile
        shell: bash
        run: |
          PROFILE_DIR="xfce-profile"
          rm -rf "$PROFILE_DIR"
          cp -r /usr/share/archiso/configs/releng "$PROFILE_DIR"

          # Create directories
          mkdir -p "$PROFILE_DIR/airootfs/root/.config/autostart"
          mkdir -p "$PROFILE_DIR/airootfs/etc/lightdm"
          mkdir -p "$PROFILE_DIR/airootfs/etc/systemd/system/getty@tty1.service.d"

          # 1. Packages
          for pkg in xfce4 xfce4-goodies xorg-server lightdm lightdm-gtk-greeter polkit polkit-gnome networkmanager network-manager-applet firefox htop gparted ncdu dbus; do
            echo "$pkg" >> "$PROFILE_DIR/packages.x86_64"
          done

          # 2. Fix polkitd and root accounts
          printf "root::0:0:root:/root:/bin/bash\npolkitd:x:102:102:PolicyKit daemon:/var/lib/polkit-1:/usr/bin/nologin\n" > "$PROFILE_DIR/airootfs/etc/passwd"
          printf "root:x:0:root\npolkitd:x:102:\nautologin:x:96:root\n" > "$PROFILE_DIR/airootfs/etc/group"

          # 3. Disable TTY1 autologin conflict
          printf "[Service]\nExecStart=\nExecStart=-/usr/bin/agetty --noclear %%I \$TERM\n" > "$PROFILE_DIR/airootfs/etc/systemd/system/getty@tty1.service.d/autologin.conf"

          # 4. LightDM Autologin Config
          printf "[Seat:*]\ngreeter-session=lightdm-gtk-greeter\nautologin-user=root\nautologin-session=xfce\nuser-session=xfce\nautologin-user-timeout=0\n" > "$PROFILE_DIR/airootfs/etc/lightdm/lightdm.conf"

          # 5. Enable Services
          ln -sf /usr/lib/systemd/system/lightdm.service "$PROFILE_DIR/airootfs/etc/systemd/system/display-manager.service"
          ln -sf /usr/lib/systemd/system/NetworkManager.service "$PROFILE_DIR/airootfs/etc/systemd/system/multi-user.target.wants/NetworkManager.service"

          # 6. --- START OF ZSTD COMPRESSION MODIFICATIONS ---
          # Step 1: Change xz to zstd and set compression level 5
          sed -i "s|'-comp' 'xz'|'-comp' 'zstd' '-Xcompression-level' '5'|" "$PROFILE_DIR/profiledef.sh"

          # Step 2: Remove the xz-specific BCJ filter
          sed -i "s|'-Xbcj' 'x86'||" "$PROFILE_DIR/profiledef.sh"

          # Step 3: Remove the xz-specific dictionary size option
          sed -i "s|'-Xdict-size' '1M'||" "$PROFILE_DIR/profiledef.sh"
          # --- END OF ZSTD COMPRESSION MODIFICATIONS ---

          # 7. Branding & ISO Metadata
          sed -i 's|^iso_name=.*|iso_name="auto-arch-xfce"|' "$PROFILE_DIR/profiledef.sh"
          sed -i 's|^iso_label=.*|iso_label="AUTO_ARCH_XFCE"|' "$PROFILE_DIR/profiledef.sh"
          
          # 8. Installer, Keymap, and Firmware Hook
          curl -fsSL https://raw.githubusercontent.com/georgeabr/arch/refs/heads/master/arch.sh -o "$PROFILE_DIR/airootfs/root/arch.sh"
          chmod +x "$PROFILE_DIR/airootfs/root/arch.sh"
          
          mkdir -p "$PROFILE_DIR/airootfs/etc"
          printf "KEYMAP=uk\nXKBLAYOUT=gb\nFONT=ter-922b\n" > "$PROFILE_DIR/airootfs/etc/vconsole.conf"

          mkdir -p "$PROFILE_DIR/airootfs/etc/pacman.d/hooks"
          printf "[Trigger]\nOperation = Install\nType = Package\nTarget = linux-firmware\n\n[Action]\nDescription = Remove firmware\nWhen = PostTransaction\nExec = /usr/bin/rm -rf /usr/lib/firmware/nvidia /usr/lib/firmware/mrvl\n" > "$PROFILE_DIR/airootfs/etc/pacman.d/hooks/remove-unneeded-fw.hook"

          echo "PROFILE_DIR=$PROFILE_DIR" >> "$GITHUB_OUTPUT"

      - name: Build ISO
        id: build_iso
        run: |
          OUT="out"
          mkarchiso -v -o "$OUT" ${{ steps.prepare_profile.outputs.PROFILE_DIR }}/
          echo "iso_path=$(find "$OUT" -name "*.iso" -print -quit)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build_iso.outputs.iso_path }}
          tag_name: "iso-${{ github.run_id }}"
          name: "Auto Arch with XFCE"
          body: |
            ### Build Information
            - **Branding**: Auto Arch with XFCE.
            - **Compression**: ZSTD Level 5.
            - **Login**: Automatic root login to desktop.
            - **Installer**: Run `/root/arch.sh` in terminal.
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
