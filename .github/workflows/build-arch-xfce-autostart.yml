name: Build Arch Linux ISO with XFCE

on:
  workflow_dispatch:
    inputs:
      build_date:
        description: 'ISO build timestamp (YYYYMMDD_HHMMSS). Leave empty for current time.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:latest
      options: --privileged
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install archiso, tools & p7zip
        run: |
          pacman -Sy --noconfirm \
            archiso squashfs-tools xorriso dosfstools \
            p7zip curl util-linux binutils jq

      - name: Prepare XFCE profile
        id: prepare_profile
        shell: bash
        run: |
          PROFILE=xfce-profile
          rm -rf "$PROFILE"
          cp -r /usr/share/archiso/configs/releng "$PROFILE"

          mkdir -p \
            "$PROFILE/airootfs/root/.config/autostart" \
            "$PROFILE/airootfs/etc/lightdm" \
            "$PROFILE/airootfs/etc/systemd/system/getty@tty1.service.d"

          # 1. Add Essential GUI and Auth packages
          # polkit is mandatory; polkit-gnome provides the agent
          for pkg in \
            xfce4 xfce4-goodies xorg-server lightdm lightdm-gtk-greeter \
            polkit polkit-gnome networkmanager network-manager-applet \
            firefox htop iotop gparted ncdu
          do
            echo "$pkg" >> "$PROFILE/packages.x86_64"
          done

          # 2. THE "SHIT-PREVENTION" FIX: Create mandatory system users/groups
          # Without these, polkitd fails to spawn (Invalid Argument / Unknown User)
          mkdir -p "$PROFILE/airootfs/etc"
          {
            echo 'root:x:0:0:root:/root:/bin/bash'
            echo 'polkitd:x:102:102:PolicyKit daemon:/var/lib/polkit-1:/usr/bin/nologin'
          } > "$PROFILE/airootfs/etc/passwd"

          {
            echo 'root:x:0:root'
            echo 'polkitd:x:102:'
            echo 'autologin:x:96:root'
          } > "$PROFILE/airootfs/etc/group"

          # 3. DISABLE TTY1 Autologin conflict
          cat <<EOF > "$PROFILE/airootfs/etc/systemd/system/getty@tty1.service.d/autologin.conf"
[Service]
ExecStart=
ExecStart=-/usr/bin/agetty --autologin root --noclear %I \$TERM
EOF

          # 4. Enable LightDM and NetworkManager
          ln -s /usr/lib/systemd/system/lightdm.service \
            "$PROFILE/airootfs/etc/systemd/system/display-manager.service"
          ln -s /usr/lib/systemd/system/NetworkManager.service \
            "$PROFILE/airootfs/etc/systemd/system/multi-user.target.wants/NetworkManager.service"

          # 5. Configure LightDM for TRUE Autologin
          {
            echo '[Seat:*]'
            echo 'greeter-session=lightdm-gtk-greeter'
            echo 'autologin-user=root'
            echo 'autologin-session=xfce'
            echo 'user-session=xfce'
            echo 'autologin-user-timeout=0'
          } > "$PROFILE/airootfs/etc/lightdm/lightdm.conf"

          # 6. Polkit Agent Autostart
          cat <<EOF > "$PROFILE/airootfs/root/.config/autostart/polkit-gnome.desktop"
[Desktop Entry]
Type=Application
Name=Polkit Gnome
Exec=/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
OnlyShowIn=XFCE;
EOF

          # 7. ISO Naming and Compression
          sed -i -e 's|^iso_name=.*|iso_name="archlinux-xfce-auto"|' -e 's|^iso_label=.*|iso_label="ARCH_XFCE_AUTO"|' "$PROFILE/profiledef.sh"
          sed -i "s|'-comp' 'xz'|'-comp' 'zstd' '-Xcompression-level' '5'|" "$PROFILE/profiledef.sh"
          sed -i "s|'-Xbcj' 'x86'||" "$PROFILE/profiledef.sh"
          sed -i "s|'-Xdict-size' '1M'||" "$PROFILE/profiledef.sh"
        
          # 8. Script and Shell setup
          curl -fsSL https://raw.githubusercontent.com/georgeabr/arch/refs/heads/master/arch.sh -o "$PROFILE/airootfs/root/arch.sh"
          chmod +x "$PROFILE/airootfs/root/arch.sh"
          
          echo "profile_dir=$PROFILE" >> "$GITHUB_OUTPUT"

      - name: Determine build timestamp
        id: ts
        shell: bash
        run: |
          BT="${{ github.event.inputs.build_date }}"
          [ -z "$BT" ] && BT=$(date '+%Y%m%d_%H%M%S')
          echo "build_timestamp=$BT" >> "$GITHUB_OUTPUT"

      - name: Build the ISO
        id: build_iso
        shell: bash
        run: |
          mkarchiso -v -o out "${{ steps.prepare_profile.outputs.profile_dir }}"
          echo "iso_path=$(find out -name '*.iso' -print -quit)" >> "$GITHUB_OUTPUT"

      - name: Fetch kernel version
        id: fetch_kernel
        shell: bash
        run: |
          V=$(curl -s 'https://archlinux.org/packages/core/x86_64/linux/json/' | jq -r '.pkgver + "-" + .pkgrel')
          echo "KERNEL_VERSION_REPO=$V" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build_iso.outputs.iso_path }}
          tag_name: "iso-${{ steps.ts.outputs.build_timestamp }}"
          name: "Arch Linux XFCE Auto ISO ${{ steps.ts.outputs.build_timestamp }}"
          body: |
            ### Build Information
            - **Profile**: `xfce-profile` built on `${{ steps.ts.outputs.build_timestamp }}`.
            - **Kernel**: `${{ steps.fetch_kernel.outputs.KERNEL_VERSION_REPO }}` (Nvidia/Marvell firmware removed).
            - **Packages**: `htop`, `iotop`, `mc`, `gparted`, `ncdu`, `trizen`.

            ### Usage Instructions
            - **Environment**: Root shell is `/bin/bash`; installer at `/root/arch.sh`.
            - **Commands**: XFCE autostarts; use `./arch.sh` in a terminal to install.
            - **Logging**: Sessions are logged to a timestamped `.log` file.
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
